### DBus消息的结构

- **消息头（Header）**：包括固定签名和含义的值块。
- **消息体（Body）**：包括零个或多个参数（类型化的值）。

#### 消息头

消息头的签名为：
```
"yyyyuua(yv)"
```
即：
```
BYTE, BYTE, BYTE, BYTE, UINT32, UINT32, ARRAY of STRUCT of (BYTE,VARIANT)
```

消息头包括以下内容：

| 值               | 描述                                              |
| --------------- | ----------------------------------------------- |
| 第1个BYTE         | 字节序标志：'l'表示小端，'B'表示大端。                          |
| 第2个BYTE         | 消息类型：例如METHOD_CALL、METHOD_RETURN、ERROR、SIGNAL等。 |
| 第3个BYTE         | 标志：例如NO_REPLY_EXPECTED等。                        |
| 第4个BYTE         | 协议的主要版本号。                                       |
| 第1个UINT32       | 消息体的字节长度。                                       |
| 第2个UINT32       | 消息的序列号。                                         |
| ARRAY of STRUCT | 头部字段的数组，其中每个字段是一个BYTE和一个VARIANT。                |

1. **字节顺序（Byte Order）**：
   - 头部的第一个字节表示字节顺序（endianness）：`'l'` 表示小端字节序，`'B'` 表示大端字节序。

2. **消息类型（Message Type）**：
   - 头部的第二个字节表示消息类型。已定义的消息类型包括：

| 名称            | 值   | 描述             |
| ------------- | --- | -------------- |
| INVALID       | 0   | 无效类型。          |
| METHOD_CALL   | 1   | 方法调用消息，可能会有回复。 |
| METHOD_RETURN | 2   | 方法返回消息。        |
| ERROR         | 3   | 错误消息。          |
| SIGNAL        | 4   | 信号消息。          |

3. **标志（Flags）**：
   - 头部的第三个字节是标志位，用于指示消息的某些属性。已定义的标志包括：
     - `NO_REPLY_EXPECTED`（值为0x1）：此消息不期望回复。
	     - `NO_AUTO_START`（值为0x2）：总线不应启动目标名称的所有者来响应此消息。
     - `ALLOW_INTERACTIVE_AUTHORIZATION`（值为0x4）：调用方准备等待交互式授权。

4. **协议版本（Protocol Version）**：
   - 头部的第四个字节表示发送应用程序的主要协议版本。

5. **消息体长度（Body Length）**：
   - 第一个 UINT32 表示消息体的字节长度，从头部结束后的第一个字节开始计算。

6. **序列号（Serial Number）**：
   - 第二个 UINT32 表示消息的序列号，用于标识请求对应的回复。

对Serial Number进行补充解释：

> 这个Serial Number是对客户端发送的消息的标记，服务端进行回复的时候，他的头部字段的REPLY_SERIAL就会记录这个编号。
> 注意和头部字段的reply serial 做区分

7. **头部字段数组（Header Fields）**：
   - 头部包含一个字段数组，其中每个字段是一个 BYTE 和一个 VARIANT 的结构，BYTE是字段的代码，表示字段的类型。常见的头部字段包括：

| 名称           | 代码  | 类型          | 描述                    |
| ------------ | --- | ----------- | --------------------- |
| INVALID      | 0   | N/A         | 无效字段名，不允许出现在消息中。      |
| PATH         | 1   | OBJECT_PATH | 方法调用的目标对象或信号发出的对象路径。  |
| INTERFACE    | 2   | STRING      | 方法调用的接口或信号发出的接口。      |
| MEMBER       | 3   | STRING      | 方法名或信号名。              |
| ERROR_NAME   | 4   | STRING      | 错误消息的名称。              |
| REPLY_SERIAL | 5   | UINT32      | 回复消息对应的请求消息的序列号。      |
| DESTINATION  | 6   | STRING      | 目标连接的名称。              |
| SENDER       | 7   | STRING      | 发送者连接的唯一名称。           |
| SIGNATURE    | 8   | SIGNATURE   | 消息体的签名。如果省略，假定为空签名。   |
| UNIX_FDS     | 9   | UINT32      | 随消息一起传送的Unix文件描述符的数量。 |


**实例**：

| Byte(s) | Value                                    | Field                | Notes                      |
|---------|------------------------------------------|----------------------|----------------------------|
| 0       | 0x6c                                     | 1st BYTE: 字节序标志 | 'l' 表示小端字节序          |
| 1       | 0x01                                     | 2nd BYTE: 消息类型   | METHOD_CALL                |
| 2       | 0x00                                     | 3rd BYTE: 标志位     | 无标志                     |
| 3       | 0x01                                     | 4th BYTE: 协议版本   | 版本 1                     |
| 4-7     | 0x10 00 00 00                            | 1st UINT32: 消息体长度| 16字节，小端格式            |
| 8-11    | 0x7b 00 00 00                            | 2nd UINT32: 消息序列号| 123，小端格式               |
| 12      | 0x01                                     | 路径字段代码          | 路径                       |
| 13-16   | 0x13 00 00 00                            | 路径长度              | 19字节，小端格式            |
| 17-35   | `/org/example/Object 0x00`               | 路径内容              | 路径字符串，后跟0字节       |
| 36      | 0x02                                     | 接口字段代码          | 接口                       |
| 37-40   | 0x14 00 00 00                            | 接口长度              | 20字节，小端格式            |
| 41-60   | `org.example.Interface 0x00`             | 接口内容              | 接口字符串，后跟0字节       |
| 61      | 0x03                                     | 成员字段代码          | 成员                       |
| 62-65   | 0x0d 00 00 00                            | 成员长度              | 13字节，小端格式            |
| 66-78   | `ExampleMethod 0x00`                     | 成员内容              | 成员字符串，后跟0字节       |
| 79      | 0x06                                     | 目的地字段代码        | 目的地                     |
| 80-83   | 0x16 00 00 00                            | 目的地长度            | 22字节，小端格式            |
| 84-105  | `org.example.Destination 0x00`           | 目的地内容            | 目的地字符串，后跟0字节     |


#### 消息体
消息体包含零个或多个参数，这些参数是类型化的值，如整数或字节数组。消息体由消息头的头部字段中的签名（SIGNATURE）指定。

例如，一个签名字符串 `"s"` 表示消息体包含一个字符串；签名字符串 `"si"` 表示消息体包含一个字符串和一个32位整数；签名字符串 `"a{sv}"` 表示消息体包含一个字符串-变体字典数组。


##### 示例

假设我们有一个方法调用消息，其签名为 `"si"`，表示消息主体包含一个字符串和一个32位整数。

```plaintext
Method Call:
Signature: "si"
Body:
  - STRING: "example"
  - INT32:  42
```

**头部（Header）**：

```plaintext
0x6c                         // 字节顺序（'l' 表示小端）
0x01                         // 消息类型（1 表示方法调用）
0x00                         // 标志（无标志）
0x01                         // 协议版本（1）
0x1c 0x00 0x00 0x00          // 消息体长度（28字节）
0x01 0x00 0x00 0x00          // 序列号（1）
0x08                         // 签名字段（包含一个签名和一个变体）
0x01 0x73                    // 签名字段的签名（1字节的签名，值为's'）
```

**消息体（Body）**：

```plaintext
0x07 0x00 0x00 0x00          // 字符串长度（7字节）
0x65 0x78 0x61 0x6d 0x70 0x6c 0x65 0x00 // 字符串"example" + 终止符
0x2a 0x00 0x00 0x00          // 32位整数42
```


假设我们有一个信号消息，其签名为 `"a{sv}"`，表示消息主体包含一个字符串-变体字典数组。

```plaintext
Signal:
Signature: "a{sv}"
Body:
  - ARRAY of DICT_ENTRY:
    - DICT_ENTRY:
      - STRING: "key1"
      - VARIANT (STRING): "value1"
    - DICT_ENTRY:
      - STRING: "key2"
      - VARIANT (INT32): 123
```

**头部（Header）**：

```plaintext
0x6c                         // 字节顺序（'l' 表示小端）
0x04                         // 消息类型（4 表示信号）
0x00                         // 标志（无标志）
0x01                         // 协议版本（1）
0x40 0x00 0x00 0x00          // 消息体长度（64字节）
0x02 0x00 0x00 0x00          // 序列号（2）
0x08                         // 签名字段（包含一个签名和一个变体）
0x05 0x61 7b 73 76 7d        // 签名字段的签名（5字节的签名，值为'a{sv}'）
```

**消息体（Body）**：

```plaintext
0x28 0x00 0x00 0x00          // 数组长度（40字节）
0x00 0x00 0x00 0x00          // 对齐填充
0x04 0x00 0x00 0x00          // 字符串"key1"的长度（4字节）
0x6b 0x65 0x79 0x31 0x00     // 字符串"key1" + 终止符
0x01                         // 变体签名的长度（1字节）
0x73                         // 变体签名（值为's'）
0x06 0x00 0x00 0x00          // 变体内容的长度（6字节）
0x76 0x61 0x6c 0x75 0x65 0x31 0x00 // 变体内容"string" + 终止符
0x04 0x00 0x00 0x00          // 字符串"key2"的长度（4字节）
0x6b 0x65 0x79 0x32 0x00     // 字符串"key2" + 终止符
0x01                         // 变体签名的长度（1字节）
0x69                         // 变体签名（值为'i'）
0x7b                         // 变体内容123（32位整数）
```
### DBus协议的编组（Marshaling）格式

DBus定义了一种用于其类型系统的编组（marshalling）格式，该格式用于DBus消息。这是将类型系统编组成字节块的格式。

#### 字节顺序和对齐

- **字节顺序（Byte Order）**：消息头包含字节顺序标志，指示消息是小端字节序（little-endian）还是大端字节序（big-endian）。
- **自然对齐（Natural Alignment）**：每个值都按其自然边界对齐，例如，4字节值对齐到4字节边界，8字节值对齐到8字节边界。对齐填充应为最小的必需填充，并且填充字节应为0。

#### 编组基本类型

- **固定类型**：按照签名中的类型代码，从数据块中读取一个值。所有有符号整数值采用二进制补码编码，双精度浮点值采用IEEE 754标准，布尔值编码为32位。
- **字符串类型**：包括STRING、OBJECT_PATH和SIGNATURE。这些类型的编组方式为固定长度的无符号整数n表示变长部分的长度，后跟n个非零字节的UTF-8文本，最后跟一个0字节（不计入文本长度）。

#### 编组容器类型

- **数组（ARRAY）**：数组以一个UINT32表示数组数据的字节长度，后跟对齐填充和数组元素。数组的最大长度为2的26次方（67108864字节，64 MiB）。
- **结构体（STRUCT）和字典项（DICT_ENTRY）**：始终对齐到8字节边界，无论其内容的对齐方式如何。
- **变体（VARIANT）**：包含内容的SIGNATURE，后跟按该签名编组的值。变体本身的对齐为1字节。

#### 下面是类型的总结：

| 类型名          | 编码方式                                                                                             | 对齐 |
|-----------------|------------------------------------------------------------------------------------------------------|------|
| INVALID         | 不适用；无法编组。                                                                                   | N/A  |
| BYTE            | 单个8位字节。                                                                                        | 1    |
| BOOLEAN         | 编码为UINT32，但仅0和1是有效值。                                                                     | 4    |
| INT16           | 16位有符号整数，按消息的字节顺序。                                                                  | 2    |
| UINT16          | 16位无符号整数，按消息的字节顺序。                                                                  | 2    |
| INT32           | 32位有符号整数，按消息的字节顺序。                                                                  | 4    |
| UINT32          | 32位无符号整数，按消息的字节顺序。                                                                  | 4    |
| INT64           | 64位有符号整数，按消息的字节顺序。                                                                  | 8    |
| UINT64          | 64位无符号整数，按消息的字节顺序。                                                                  | 8    |
| DOUBLE          | 64位IEEE 754双精度浮点数，按消息的字节顺序。                                                        | 8    |
| STRING          | 一个UINT32表示字符串的字节长度（不包括终止的nul），后跟给定长度的非nul字符串数据，最后是终止的nul字节。 | 4    |
| OBJECT_PATH     | 与STRING相同，但内容必须是有效的对象路径。                                                           | 4    |
| SIGNATURE       | 与STRING相同，但长度是单个字节（最大长度为255），内容必须是有效的签名。                               | 1    |
| ARRAY           | 一个UINT32表示数组数据的字节长度，后跟对齐填充和数组元素。                                           | 4    |
| STRUCT          | 结构体必须从8字节边界开始，无论结构体字段的类型。                                                    | 8    |
| VARIANT         | 编组的单个完整类型的签名，后跟按签名类型编组的值。                                                  | 1    |
| DICT_ENTRY      | 与STRUCT相同。                                                                                       | 8    |
| UNIX_FD         | 32位无符号整数，按消息的字节顺序。值在消息传送时存储为文件描述符数组中的索引。                       | 4    |
